# 网络层
## 涉及到的硬件
## 涉及到的软件
## 开篇的重点
+ 虚拟互联网络的概念
+ IP地址与物理地址的关系
+ 传统的分类的IP地址(包括字码掩网) 和 无分类域间选择器选择 CIDR
+ 路由选择协议的工作原理

## 网络层提供的服务
网络层应该给运输层什么样的服务
面向连接 还是 无连接
可靠交付
### 网络设计思路
1. 网络层只是尽力的交付数据 只传不更改
+ 网络层向上只提供简单灵活的 无连接 尽最大努力交付的数据报服务+ 
+ 网络在发送分组时不需要建立连接 每一个分组独立发送  与其前后分组无关
+ 网络层不提供服务质量的承诺 所传递数据可能出错 丢失 重复 也不保证分组传送的时限  只负责传送
2. 尽力交付好处
+ 传输网络不提供端到端的可靠传输服务 使网络中的路由器可以做的简单 与电信网的交换机相比 价格低廉
+ 如果主机中的进程间的通信需要是可靠的 由网络的主机中的运输层负责
3. 设计思路优点 网络造价大大降低 运行方式灵活 能适应多种应用
### 虚电路服务
+ 面向连接的通信方式
+ 建立虚电路 保证双方通信所需的一切资源
+ 如果再使用可靠传输的协议 就可以使所发送的分组无差错的按序到达终点
+ 虚电路是虚拟的逻辑连接 分组沿着这条逻辑连接按照存储转发方式传送 并不是真实的物理连接
+ 分组交换的虚连接与电路连接不同 只是类似 电路连接是真正的建立了一条线
![](netphoto/contrastNet.png)
+ 虚电路服务与数据报服务的区别
### 数据报服务

## 网际IP协议
TCP/IP体系中 两个最重要的协议之一
与ip协议配套使用的还有四个协议
+ 地址解析协议 ARP Ip地址经过 ABR转换后 得到物理地址
+ 逆地址解析协议RARP 物理地址经过 RARP转换后 得到IP地址
+ 网际控制报文协议 ICMP
+ 网际管理协议 IGMP
![](netphoto/protocol.png)

## 虚拟互连网络
0. 涉及到问题 
+ 不同的寻址方案
+ 不同的最大分组长度
+ 不同的网络接入机制
+ 不同的超时控制
+ 不同的差错恢复方法
+ 不同的状态报告方法
+ 不同的路由选择技术
+ 不同的用户接入控制
+ 不同的服务
+ 不同的管理与控制方式
如何解决？

1. 网络互连涉及的物理设备
中间设备/中间系统/中继设备(relay 依赖？)
+ 物理层中继系统：转发器(repeater)
+ 物理链路层中继系统：网桥或桥接器(bridge)
+ 网络层中继系统：路由器(router)
+ 网桥和路由器的混合物“桥路器(broute)
+ 网络层以上的中继系统：网关(gateway)

2. 使用各种中继系统的区别
+ 当中继系统是转发器或网桥时 只是扩大了网络范围 并不是一个互连网络
+ 网关比较复杂 目前使用较少
+ 互联网是指用路由器进行互连的网络
+ 由于历史原因 tcp/ip文献将网络层使用的路由器叫网关

3. 意义
+ 使用逻辑互连网络可以使得各个物理网络的异构性在利用IP协议时看起来像个统一个网络
+ 使用IP协议的虚拟互连网络简称为IP网
+ 使用虚拟互连网络的好处：当互联网主机进行通信时 就像一个网络上通信 但看不见互连的各个具体的网络异构细节

### 分类的IP地址
1. Ip地址的表示方法
+ IP地址给每个连接在互联网上的主机或路由器分配一个全世界范围是唯一的 32 位的标识符
+ IP地址现在由ICANN分配 // 因特网名字与号码指派公司

2. IP地址的编址方法
+ 分类的IP地址
+ 子网的划分
+ 构成超网

3. 分类IP地址
+ 每一类地址都由两个固定长度的字段组成 其中一个字段是
网络号:net-id 标志主机/路由器连接到的网络
主机号：host-id 标志主机或路由器
ip地址::={<网络号>,<主机号>}  ::= 代表定义为
+ Ip地址中的网络号字段和主机号
A类地址：0 8位 net-id + 24位 host-id
B类地址：10 net-id(16位)
C类地址：110 net-id(24位)
D类地址: 1110 + 多播地址
E类地址：1111 + 保留为今后使用
8位一个字节？

+ 点分十进制记法
机器中存放IP地址32位
每隔8位插入一个空格
再每8位二进制转为十进制
形成了最后的IP
128.11.3.31

4. IP地址的重要特点
+ IP地址是一种分等级的地址结构 分两个等级的好处
IP地址管理机构分配IP地址时只分配网络号 其他的由该网络自行分配 方便管理
路由器仅根据目的主机所连接的网络号进行转发分组 这样使得路由表中的项目数大幅度减少
从而减少路由表所占的存储空间
+ 实际上IP地址是标志一个主机与一条链路的接口

+ 用转发器或网桥连接起来的若干个局域网仍然为一个网络 这些局域网有着同样的网络号 net-id
192.168.2.xxxx 前面的net-id一致 说明是同一个网络

+ 所有分配到网络号 net-id的网络 范围无论大小的 都是平等的 无论是局域网还是广域网

+ 路由器总是具有两个或两个以上的IP地址 路由器的每一个接口都有不同的IP地址
路由器有多个IP与不同的路由器连接一起 主机通过路由器与不同net-id的网络相连在了一起
![](netphoto/routeMachine.png)

5. ip地址与硬件地址
网络层以上使用IP地址 
链路层以下使用硬件地址

6. 地址解析协议ABR和逆地址解析协议RABR
+ 无论网络层使用什么协议 在链路层上传输数据帧的时候 最终还是必须使用硬件地址
+ 每一个主机都拥有一个ARP高速缓存 里面有所在 局域网  上的各主机和路由器的IP地址到硬件地址的映射表
+ 当主机A想向主机B发送IP数据时 会先去ARPCache里查找有无对应的IP地址 再找到对应的硬件地址 封装到MAC帧上 局域网把该MAC帧发送到B的硬件地址
总的来说 ARP存了所有局域网内所有主机的地址 每次使用前都可以去查 查到就能顺利TP
+ 为了减少网络通讯量 主机A发送ARP请求分组时 就将自己的IP地址到硬件地址的映射写入ARP请求分组 B接收的时候把A的映射地址存入自己的ABR缓存中 下次通讯就快很多
类似于发送快递的时候 顺带了自己的地址 这样返回来就快的多了

7. ARP需要注意的问题
+ ARP解决的是同一个局域网的主机或者路由器的硬件地址与IP地址映射 如果不在一个局域网 就找到路由器的地址 转发给路由器 由路由器去转发给另一个网络
+ IP地址与硬件地址的解析是自动的 主机用户是不知道这个过程的 只要主机和已知网络的任意一个IP进行通信 ARP协议就会自动把IP地址解析为链路层需要的硬件地址
+ 因为IP地址统一且通信方便 硬件地址因为各式各样的格式不统一 所以不会选择硬件格式直接通信
+ 四种情形  主机给路由器 路由器给路由器 路由器给主机  主机给主机

8. IP数据报的格式
由首部和数据两部分组成
首部 20个字节固定字段 + 长度可变的额外字段
数据
// 许多构成和名词等待记录
![](netphoto/ipData.png)
9. IP层转发分组的流程
+ 按主机所在的网络地址来制作路由表比按目的主机号制作要节约空间的多 对4个A类网络 3个路由器来说 每个路由表只需要4个项目
在路由表中 最重要的是下一跳的地址 也就是路由器间相互交换沟通的地方 经过一次次的间接交付 到达最后一个路由器才交付给主机
(类似快递) 经历一个个快递点转发 

+ IP数据报的首部中没有地方可以用来指明 下一跳路由器的IP地址
+ 当路由器收到待转发的数据报时 不是将下一跳路由器的IP地址填入IP数据报 而是送交给下层的网络接口软件
+ 网络接口软件负责使用ARP将下一跳路由器地址转为硬件地址  并将此硬件地址 放在链路层的MAC帧的首部
然后根据这个硬件地址找到下一跳路由器

+ 路由种类

10. 分组转发算法
1. 从数据报首部提取目的主机的IP地址D  得出的网络地址为N
2. 若网络N与此路由器直接相连 则把数据报直接交付目的主机D 否则间接交付交付 执行3
3. 路由表中有目的地址为D的特定主机路由 则把数据报传送给路由表中所指明的下一跳路由器  否则执行4
4. 若路由表中有达到网络N的路由 则把数据传递给路由表指明的下一跳路由器 否则执行5
5. 若路由表中有一个默认路由 则把数据报传送给路由表中所指明的默认路由器 否则执行6
6. 报告转发出错

从三条路线分别 按IP地址 网络地址 默认路由开始查找 如果都没 那就有问题
## 划分网络子网和构造超网
